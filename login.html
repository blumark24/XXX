<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart HSR - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>

  <!-- FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-teal:#0ea5a1;
      --secondary-navy:#0b2b3a;
      --card-bg:#ffffff;
      --button-shadow:rgba(14,165,161,0.4);
    }
    * { box-sizing:border-box; }
    body {
      margin:0; font-family:'Tajawal',sans-serif;
      background:linear-gradient(180deg,#f7f9fb 0%,#f0f2f5 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden; padding:30px;
    }
    body::before{
      content:""; position:absolute; inset:0;
      background:url('Smart_HSR_Dashboard_Logo.svg') center center no-repeat;
      background-size:40%; opacity:.08; z-index:0;
    }
    .card{
      width:380px; background:var(--card-bg); border-radius:24px;
      box-shadow:0 15px 40px rgba(10,20,50,0.15);
      padding:40px 30px; border:1px solid #e9ecef;
      position:relative; overflow:hidden; z-index:1;
      transition:all .3s ease; backdrop-filter:blur(4px);
    }
    .card:hover{ box-shadow:0 18px 45px rgba(14,165,161,0.2); }
    .card-header-line{
      position:absolute; top:0; left:0; right:0; height:5px;
      background:linear-gradient(90deg,var(--primary-teal),var(--secondary-navy));
      border-top-left-radius:24px; border-top-right-radius:24px;
    }
    .logo{ display:block; width:120px; margin:20px auto 15px; }
    h1{ margin:0 0 4px 0; text-align:center; font-size:28px; color:var(--secondary-navy); font-weight:900; }
    p.lead{ margin:0 0 25px 0; text-align:center; color:#6c757d; font-weight:500; font-size:16px; }
    .field{ margin-bottom:18px; }
    .field label{ display:block; margin-bottom:8px; color:var(--secondary-navy); font-size:14px; font-weight:600; }
    input[type="email"],input[type="password"]{
      width:100%; padding:14px 18px; border-radius:12px; border:1px solid #d4dce4;
      background:#f8f9fa; font-size:16px; outline:none; transition:border-color .3s, box-shadow .3s;
    }
    input:focus{ border-color:var(--primary-teal); box-shadow:0 0 0 3px rgba(14,165,161,0.1); background:#fff; }
    .btn{
      width:100%; padding:14px; border-radius:12px; border:none;
      cursor:pointer; font-weight:700; font-size:17px;
      transition:all .3s ease; display:flex; align-items:center; justify-content:center;
    }
    .btn-primary{
      background:linear-gradient(90deg,var(--primary-teal),#0b7285);
      color:#fff; box-shadow:0 10px 20px var(--button-shadow);
    }
    .btn-primary:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 12px 25px var(--button-shadow);
      background:linear-gradient(90deg,#0b7285,var(--primary-teal));
    }
    .message{ text-align:center; margin-top:15px; font-weight:600; font-size:15px; }
    .error{ color:#dc3545; } .success{ color:#198754; }
    .muted{ font-size:13px; color:#7b8a90; text-align:center; margin-top:15px; }
    .loading-spinner{
      border:3px solid rgba(255,255,255,.3); border-top:3px solid white;
      border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite; margin-left:10px;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    #loadingOverlay {
      position:fixed; inset:0;
      background:linear-gradient(135deg,#0b2b3a 0%,#0ea5a1 100%);
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index:9999; color:white; text-align:center;
    }
    .loader-logo { width:120px; animation:pulse 1.5s infinite ease-in-out; }
    .loader-text { font-size:1.2rem; font-weight:700; margin-top:1.5rem; opacity:0.9; }
    @keyframes pulse{0%{transform:scale(1);opacity:1;}50%{transform:scale(1.1);opacity:0.8;}100%{transform:scale(1);opacity:1;}}
  </style>
</head>

<body>
  <div class="card" role="main">
    <div class="card-header-line"></div>
    <img src="Smart_HSR_Dashboard_Logo.svg" alt="Ø´Ø¹Ø§Ø± Smart HSR" class="logo">
    <h1>Smart HSR</h1>
    <p class="lead">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©</p>

    <form id="loginForm" onsubmit="event.preventDefault(); signInWithEmail();">
      <div class="field">
        <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ù„Ù…Ø¹ØªÙ…Ø¯):</label>
        <input id="email" name="email" type="email" placeholder="example@smart-hsr.com" required />
      </div>
      <div class="field">
        <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
        <input id="password" name="password" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required />
      </div>
      <button type="submit" id="loginButton" class="btn btn-primary" style="margin-top:10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>

    <div id="msg" class="message"></div>
    <div class="muted">Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø®ØµØµ Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙŠÙ† ÙÙ‚Ø·.</div>
  </div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="loadingOverlay">
  <img src="Smart_HSR_Dashboard_Logo.svg" alt="Smart HSR" class="loader-logo">
  <p class="loader-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
</div>

<script type="module">
  // âœ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ø¹Ø¨Ø± firebase-core.js
  import { app, auth, db } from "./firebase-core.js";

  import {
    signInWithEmailAndPassword,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // =============================
  // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  // =============================
  const msgBox = document.getElementById('msg');
  const loginButton = document.getElementById('loginButton');
  const loadingOverlay = document.getElementById('loadingOverlay');

  function msg(text, type = '') {
    msgBox.innerText = text;
    msgBox.className = 'message ' + type;
  }

  function showLoading(show = true) {
    loadingOverlay.style.display = show ? 'flex' : 'none';
  }

  // =============================
  // âœ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
  // =============================
  async function redirectUser(user) {
    try {
      const snap = await getDoc(doc(db, 'users', user.uid));
      const role = (snap.exists() && snap.data().role)
        ? snap.data().role.toLowerCase()
        : '';

      showLoading(false);
      if (role === 'admin') {
        window.location.href = 'admin.html';
      } else {
        window.location.href = 'index.html';
      }
    } catch (e) {
      console.error("Firestore role fetch error:", e);
      showLoading(false);
      window.location.href = 'index.html';
    }
  }

  // =============================
  // âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
  // =============================
  let redirected = false;
  onAuthStateChanged(auth, (user) => {
    if (user && !redirected) {
      redirected = true;
      showLoading(true);
      setTimeout(() => redirectUser(user), 800);
    }
  });

  // =============================
  // ğŸš€ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"
  // =============================
  window.signInWithEmail = async function () {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password)
      return msg('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹.', 'error');

    loginButton.disabled = true;
    loginButton.innerHTML = `<div class="loading-spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...`;

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      msg('', '');
      showLoading(true);
      setTimeout(() => redirectUser(cred.user), 1000);
    } catch (e) {
      let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
      if (e.code.includes('user-not-found') || e.code.includes('wrong-password'))
        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
      else if (e.code.includes('too-many-requests'))
        errorMessage = 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©.';
      msg(errorMessage, 'error');
    } finally {
      loginButton.disabled = false;
      loginButton.innerHTML = `ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„`;
    }
  };
</script>
</body>
</html>
